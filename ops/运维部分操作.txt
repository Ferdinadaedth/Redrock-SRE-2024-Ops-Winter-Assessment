1.先进行OpenWRT软路由配置
在OpenWRT上创建一个新的VLAN接口，将它作为DHCP客户端以从校园网获取IP地址，再为其他网段添加静态路由，操作如下：
#创建VLAN接口
uci set network.vlan1='interface'
uci set network.vlan1.ifname='eth0.2' # 假设eth0是连接到校园网的物理接口，2是VLAN ID
uci set network.vlan1.proto='dhcp'

#保存并应用配置
uci commit network
/etc/init.d/network reload

#添加静态路由
ip route add 10.18.0.0/12 via 172.18.100.1
ip route add 202.202.32.0/20 via 172.18.100.1
ip route add 219.153.62.64/26 via 172.18.100.1
ip route add 222.177.140.0/25 via 172.18.100.1

#保存路由配置到启动脚本
echo "ip route add 10.18.0.0/12 via 172.18.100.1" >> /etc/rc.local
echo "ip route add 202.202.32.0/20 via 172.18.100.1" >> /etc/rc.local
echo "ip route add 219.153.62.64/26 via 172.18.100.1" >> /etc/rc.local
echo "ip route add 222.177.140.0/25 via 172.18.100.1" >> /etc/rc.local

2.配置服务器和网关
网关机：
在网关机中配置NAT和防火墙规则，以及设置虚拟机的网络接口
#启用IP转发
echo 1 > /proc/sys/net/ipv4/ip_forward

#设置NAT
iptables -t nat -A POSTROUTING -s 192.168.5.0/24 -o eth0 -j MASQUERADE

#设置防火墙规则以隔离新旧网段
iptables -A FORWARD -i eth1 -o eth0 -s 192.168.5.0/24 -d 172.18.100.0/24 -j REJECT
iptables -A FORWARD -i eth0 -o eth1 -s 172.18.100.0/24 -d 192.168.5.0/24 -j REJECT

#保存iptables规则
iptables-save > /etc/iptables/rules.v4

#创建开机自启脚本
echo "#!/bin/sh -e" > /etc/rc.local
echo "echo 1 > /proc/sys/net/ipv4/ip_forward" >> /etc/rc.local
echo "iptables-restore < /etc/iptables/rules.v4" >> /etc/rc.local
echo "exit 0" >> /etc/rc.local
chmod +x /etc/rc.local

配置虚拟网络（每台虚拟机的/etc/network/interfaces文件中的IP地址是唯一的，并且在192.168.5.2到192.168.5.11的范围内。）：
#编辑网络配置文件 /etc/network/interfaces
auto eth0
iface eth0 inet static
    address 192.168.5.X # X是2到11之间的数字
    netmask 255.255.255.0
    gateway 192.168.5.5 # 假设192.168.5.5是网关机的IP地址

每次修改配置后重启网络服务或虚拟机以应用新的设置：
#重启网络服务
/etc/init.d/networking restart

#重启特定网络接口
ifdown eth0 && ifup eth0
